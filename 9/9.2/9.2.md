# 9.2. Vistas

## Módulos

### 1. Planificación del mantenimiento:

1) Vista para los equipos de soporte:

* Justificación: El query utilizado en la vista representa una consulta recurrente en distintas partes del módulo, especialmente en la consulta de lista de equipos de soporte y el detalle del plan de mantenimiento.

* Implementación de la vista:
  
```sql
CREATE VIEW vista_equipos_soporte AS
SELECT 
    esm.id_act_mantto,
    json_agg(
        json_build_object(
            'id_equipo_soporte', es.id_equipo_soporte,
            'nombre_equipo_soporte', es.nombre_equipo_soporte
        )
    ) AS listaEquipos
FROM EquipoSXMantenimiento esm
INNER JOIN Equipo_de_Soporte es ON es.id_equipo_soporte = esm.id_equipo_soporte
GROUP BY esm.id_act_mantto;
```

2) Vista para los insumos:

* Justificación: El query utilizado en la vista representa una consulta recurrente en distintas partes del módulo, especialmente en la consulta de lista de insumos y el detalle del plan de mantenimiento.

* Implementación de la vista:
  
```sql
CREATE VIEW vista_insumos AS
SELECT 
    im.id_act_mantto,
    json_agg(
        json_build_object(
            'id_insumo', i.id_insumo,
            'nombre', i.nombre,
            'cantidad', im.cantidad
        )
    ) AS listaInsumos
FROM InsumoXMantenimiento im
INNER JOIN Insumo i ON i.id_insumo = im.id_insumo
GROUP BY im.id_act_mantto;
```

3) Vista para el detalle del plan de mantenimiento:

* Justificación: El query es muy complejo y siempre es estándar para este módulo. Por lo que se decidió crear una tabla virtual que permita obtener el detalle a través de un simple SELECT.

* Implementación de la vista:
  
```sql
CREATE VIEW vista_plan_mantenimiento AS
SELECT 
    CONCAT('PL-', LPAD(p.id_plan::TEXT, 4, '0')) AS id_plan,
    tm.nombre_tipo_mant,
    CONCAT('MQ-', LPAD(m.id_maquina::TEXT, 4, '0')) AS id_maquina,
    creador.nombre AS creador,
    est.estado,
    p.fecha_plan,
    m.fecha_inicio_programado,
    m.fecha_fin_programado,
    responsable.nombre AS responsable,
    crit.nivel AS criticidad,
    CONCAT('OT-', LPAD(o.id_orden::TEXT, 4, '0')) AS id_orden,
    p.descripcion,
    equipos.listaEquipos,
    insumos.listaInsumos
FROM Plan_de_mantenimiento p
INNER JOIN Mantenimiento m ON m.id_plan = p.id_plan
INNER JOIN Tipo_mantenimiento tm ON tm.id_tipo_mant = m.id_tipo_mant
INNER JOIN Empleado creador ON creador.id_empleado = p.empleado_asigna
INNER JOIN Orden_de_trabajo o ON o.id_orden = m.id_orden
INNER JOIN Actividad_empleado act ON act.id_orden = o.id_orden
INNER JOIN Empleado responsable ON responsable.id_empleado = act.id_empleado
INNER JOIN Estado_mantto est ON m.id_estado = est.id_estado
INNER JOIN Criticidad crit ON crit.id_criticidad = p.id_criticidad
LEFT JOIN vista_equipos_soporte equipos ON equipos.id_act_mantto = m.id_act_mantto
LEFT JOIN vista_insumos insumos ON insumos.id_act_mantto = m.id_act_mantto
WHERE act.nombre_actv = 'Responsable' AND m.id_estado != 8
ORDER BY p.id_plan;
```

### 2. Control del mantenimiento

### 3. Gestión de equipos de soporte

### 4. Gestión del IPERC

### 5. Gestión de insumos
1) Vista para listar insumos:

* Justificación: Por temas principalmente de seguridad, el personal de almacén solo debería tener acceso a esos datos de la tabla reserva, ya que solo estos son necesarios para su interacción con el sistema. 

* Implementación de la vista:
  
```sql
CREATE VIEW vista_reservas AS
SELECT id_reserva, fecha, hora, id_estado_reserva
FROM reserva;

```

### 6. Seguridad

### 7. Gestión de reportes e historial de mantenimiento

